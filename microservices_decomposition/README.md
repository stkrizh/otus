# Паттерны декомпозиции приложения на микросервисы
Декомпозиция на микросервисы будет рассмотрена на примере *сервиса по аренде электросамокатов*.


## Пользовательские сценарии
Для определения функциональных требований к системе используем пользовательские сценарии (англ. Use Case).

### История: Пользователь должен иметь возможность зарегистрироваться в системе

_Как новый пользователь_  
_Чтобы иметь возможность совершать действия в системе_  
_Я хочу иметь зарегистрированный аккаунт_  

#### Сценарий: Должна быть возможность зарегистрировать новый аккаунт
Дано то, что у меня нет аккаунта в системе  
И в системе нет другого аккаунта с моим адресом электронной почты  
Когда я регистрируюсь в системе, используя адрес электронной почты и произвольный пароль  
Тогда у меня должен появиться аккаунт в системе  
И я могу авторизоваться в системе  


### История: Пользователь должен иметь возможность авторизоваться в системе

_Как пользователь_  
_Чтобы иметь возможность совершать действия в системе_  
_Я хочу авторизоваться в системе_  

#### Сценарий: Должна быть возможность авторизоваться в системе
Дано то, что у меня есть аккаунт в системе  
Когда я авторизуюсь в системе, используя свой адрес электронной почты и пароль  
Тогда мне выдаётся сессионный токен для работы в системе  
И я могу совершать действия в системе, используя этот сессионный токен  


### История: Пользователь должен иметь возможность проверить баланс своего счёта

_Как пользователь_  
_Чтобы следить за состоянием своего счёта_  
_Я хочу иметь возможность проверить баланс своего счёта в системе_  

#### Сценарий: Должна быть возможность проверить баланс своего счёта в системе
Дано то, что у меня есть сессионный токен для работы в системе  
Когда я проверяю баланс своего счёта  
Тогда я должен видеть актуальный остаток денежных средств на своём счёте  


### История: Пользователь должен иметь возможность пополнить баланс своего счёта

_Как пользователь_  
_Чтобы иметь возможность арендовать электросамокат_  
_Я хочу иметь возможность пополнить баланс своего счёта_  

#### Сценарий: Должна быть возможность пополнить баланс своего счёта в системе
Дано то, что у меня есть сессионный токен для работы в системе  
Когда я пополняю баланс своего счёта в системе  
Тогда на моём счете появляются соответствующие денежные средства  
И я должен получить уведомление об успешном пополнении своего счёта


### История: Пользователь должен иметь возможность получить список электросамокатов доступных для аренды

_Как пользователь_  
_Чтобы арендовать электросамокат_  
_Я хочу получить список доступных для аренды электросамокатов_  

#### Сценарий: Должна быть возможность получить список электросамокатов доступных для аренды
Дано то, что у меня есть сессионный токен для работы в системе  
Когда я хочу получить список доступных для аренды электросамокатов  
Тогда я должен видеть список ближайших ко мне электросамокатов доступных для аренды  
И должен иметь возможность арендовать один из них, если он ещё не арендован


### История: Пользователь должен иметь возможность арендовать электросамокат доступный для аренды

_Как пользователь_  
_Чтобы воспользоваться электросамокатом_  
_Я хочу арендовать электросамокат_  

#### Сценарий: Должна быть возможность арендовать электросамокат доступный для аренды
Дано то, что у меня есть сессионный токен для работы в системе  
И на моём счёте достаточно денежных средств для аренды электросамоката  
И электросамокат доступен для аренды  
Когда я арендую этот электросамокат   
Тогда я должен получить возможность пользоваться этим электросамокатом  
И с моего счёта должны быть удержаны соответствующие денежные средства  
И этот электросамокат должен стать недоступен для аренды другими пользователями  
И я должен получить уведомление о начале аренды электросамоката  


### История: Пользователь должен иметь возможность закончить аренду электросамоката

_Как пользователь_  
_Чтобы закончить пользоваться электросамокатом_  
_Я хочу вернуть электросамокат из аренды_  

#### Сценарий: Должна быть возможность закончить аренду электросамоката
Дано то, что у меня есть сессионный токен для работы в системе  
И я арендую электросамокат  
Когда я заканчиваю аренду электросамоката  
Тогда аренда электросамоката должна закончиться  
И этот электросамокат должен стать доступным для аренды другими пользователями  
И я должен получить уведомление об окончании аренды электросамоката  


## Общая схема взаимодействия сервисов
Проанализировав спецификацию пользовательских сценариев и предметную область, методом декомпозиции приложения на микросервисы выбран метод разделения по бизнес-возможностям (англ. business capability). Достоинствами этого метода декомпозиции является следующее:

* Стабильная архитектура приложения, т.к. бизнес-возможности являются базовой характеристикой предметной области и редко изменяются
* Сервисы слабо связаны (англ. low coupling) между собой, что облегчает поддержку и развитие приложения

Общая неформальная схема взаимодействия микросервисов показана ниже:

![](https://habrastorage.org/webt/zh/d5/cm/zhd5cmgfzqsffg8wuld6rkm3csi.png)

_Стрелками показана прямая зависимость, пунктирной линией — событийное взаимодействие_


## Назначение сервисов
В этом разделе кратко обозначено назначение каждого сервиса и его зона ответственности.

### API gateway
Входной узел системы, который обрабатывает и маршрутизирует запросы пользователей.

### Сервис управления электросамокатами
Ключевой сервис системы, который отвечает за начало и окончание аренды электросамокатов. Также ведёт учёт арендованных электросамокатов и предоставляет список ближайших к пользователю электросамокатов, которые доступны для аренды.

### Сервис управления аккаунтами пользователей
Позволяет пользователям регистрироваться в системе. Зарегистрированным пользователям позволяет получить сессионный токен (при успешной аутентификации) для совершения действий в системе. Также в ответственность этого сервиса входит управления различными настройками пользовательских аккаунтов.

### Сервис платежей
Позволяет пользователям внести денежные средства на свой счёт в системе. Также позволяет отслеживать текущий баланс пользователя. При аренде электросамоката контролирует списание денежных средств со счёта пользователя.

### Сервис уведомлений
Позволяет отправлять пользователям различные уведомления связанные с действиями в системе:
* Пополнение счёта
* Начало аренды электросамоката
* Окончание аренды электросамоката

### Брокер сообщений
Компонент системы, который позволяет организовать событийное взаимодействие между сервисами.

## Спецификация API
* [Публичный API](https://github.com/stkrizh/otus/blob/master/microservices_decomposition/openapi.yaml)
* [Служебный API сервиса управления аккаунтами](https://github.com/stkrizh/otus/blob/master/microservices_decomposition/auth-service-openapi.yaml)
* [Служебный API сервиса управления электросамокатами](https://github.com/stkrizh/otus/blob/master/microservices_decomposition/scooters-management-service-openapi.yaml)
* [Служебный API сервиса платежей](https://github.com/stkrizh/otus/blob/master/microservices_decomposition/payments-service-openapi.yaml)
* [Служебный API сервиса уведомлений](https://github.com/stkrizh/otus/blob/master/microservices_decomposition/notification-service-openapi.yaml)

## Системные события
* Новый пользователь зарегистрирован
* Добавлены денежные средства на счёт пользователя
* Начата аренда электросамоката
* Закончена аренда электросамоката
